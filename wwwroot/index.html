<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Azure Weather Image Generator</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                color: white;
                margin-bottom: 30px;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .header p {
                font-size: 1.2em;
                opacity: 0.9;
            }

            .card {
                background: white;
                border-radius: 15px;
                padding: 30px;
                margin-bottom: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .api-key-section {
                margin-bottom: 20px;
            }

            .api-key-section label {
                display: block;
                font-weight: bold;
                margin-bottom: 8px;
                color: #333;
            }

            .api-key-section input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }

            .api-key-section input:focus {
                outline: none;
                border-color: #667eea;
            }

            .api-key-section small {
                display: block;
                margin-top: 5px;
                color: #666;
            }

            .button-group {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            button {
                flex: 1;
                min-width: 150px;
                padding: 15px 25px;
                font-size: 1.1em;
                font-weight: bold;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
                color: white;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .btn-success {
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            }

            .btn-info {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .status-box {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: none;
            }

            .status-box.show {
                display: block;
            }

            .status-success {
                background: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
            }

            .status-error {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
            }

            .status-info {
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                color: #0c5460;
            }

            .status-warning {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
            }

            .job-status {
                margin-top: 20px;
            }

            .progress-bar {
                width: 100%;
                height: 30px;
                background: #f0f0f0;
                border-radius: 15px;
                overflow: hidden;
                margin: 15px 0;
                display: none;
            }

            .progress-bar.show {
                display: block;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
                transition: width 0.5s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }

            .image-gallery {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .image-card {
                background: #f9f9f9;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s;
            }

            .image-card:hover {
                transform: translateY(-5px);
            }

            .image-card img {
                width: 100%;
                border-radius: 8px;
                margin-bottom: 10px;
                background: #ddd;
                min-height: 200px;
                object-fit: cover;
            }

            .image-card h3 {
                color: #333;
                margin-bottom: 5px;
                font-size: 1.1em;
            }

            .image-card p {
                color: #666;
                font-size: 0.9em;
            }

            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .endpoint-info {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                font-family: "Courier New", monospace;
            }

            .endpoint-info h3 {
                margin-bottom: 10px;
                color: #333;
            }

            .endpoint-info code {
                background: #e9ecef;
                padding: 2px 6px;
                border-radius: 4px;
                color: #d63384;
            }

            .loading {
                text-align: center;
                padding: 20px;
            }

            @media (max-width: 768px) {
                .button-group {
                    flex-direction: column;
                }

                .header h1 {
                    font-size: 1.8em;
                }

                .image-gallery {
                    grid-template-columns: 1fr;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>üå§Ô∏è Azure Weather Image Generator</h1>
                <p>
                    Generate beautiful weather images for Dutch weather stations
                </p>
            </div>

            <div class="card">
                <div class="api-key-section">
                    <label for="apiKey">üîë API Key:</label>
                    <input
                        type="text"
                        id="apiKey"
                        placeholder="Enter your API key"
                        value="test-api-key-12345"
                    />
                    <small>Default: test-api-key-12345</small>
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="testHealth()">
                        üè• Test Health
                    </button>
                    <button class="btn-primary" onclick="startJob()">
                        üöÄ Start Weather Job
                    </button>
                    <button
                        class="btn-info"
                        onclick="checkJobStatus()"
                        id="checkStatusBtn"
                        disabled
                    >
                        üìä Check Job Status
                    </button>
                </div>

                <div id="statusBox" class="status-box"></div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div class="job-status" id="jobStatus"></div>

                <div class="image-gallery" id="imageGallery"></div>

                <div class="endpoint-info">
                    <h3>üì° API Endpoints:</h3>
                    <p>
                        <strong>Base URL:</strong>
                        <code id="baseUrl"
                            >https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net</code
                        >
                    </p>
                    <p><strong>Health:</strong> <code>GET /health</code></p>
                    <p>
                        <strong>Start Job:</strong>
                        <code>POST /job/start</code>
                    </p>
                    <p>
                        <strong>Check Status:</strong>
                        <code>GET /job/{jobId}</code>
                    </p>
                </div>
            </div>
        </div>

        <script>
            const API_BASE_URL =
                "https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net";
            let currentJobId = null;
            let statusCheckInterval = null;

            function getApiKey() {
                return (
                    document.getElementById("apiKey").value ||
                    "test-api-key-12345"
                );
            }

            function showStatus(message, type = "info") {
                const statusBox = document.getElementById("statusBox");
                statusBox.className = `status-box show status-${type}`;
                statusBox.innerHTML = message;
            }

            function hideStatus() {
                const statusBox = document.getElementById("statusBox");
                statusBox.className = "status-box";
            }

            async function testHealth() {
                showStatus("üîÑ Testing health endpoint...", "info");

                try {
                    const response = await fetch(`${API_BASE_URL}/api/health`, {
                        headers: {
                            "X-API-Key": getApiKey(),
                        },
                    });

                    if (response.ok) {
                        const text = await response.text();
                        showStatus(
                            `‚úÖ Health Check Passed!<br><strong>${text}</strong>`,
                            "success"
                        );
                    } else {
                        showStatus(
                            `‚ùå Health check failed: ${response.status} ${response.statusText}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`‚ùå Error: ${error.message}`, "error");
                }
            }

            async function startJob() {
                showStatus(
                    "üöÄ Starting weather image generation job...",
                    "info"
                );
                document.getElementById("imageGallery").innerHTML = "";

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/job/start`,
                        {
                            method: "POST",
                            headers: {
                                "X-API-Key": getApiKey(),
                                "Content-Type": "application/json",
                            },
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        currentJobId = data.jobId;

                        showStatus(
                            `‚úÖ Job Started Successfully!<br><strong>Job ID:</strong> ${data.jobId}<br><strong>Status:</strong> ${data.status}`,
                            "success"
                        );

                        document.getElementById(
                            "checkStatusBtn"
                        ).disabled = false;
                        document
                            .getElementById("progressBar")
                            .classList.add("show");

                        // Auto-start checking status
                        startStatusPolling();
                    } else {
                        const errorText = await response.text();
                        showStatus(
                            `‚ùå Failed to start job: ${response.status}<br>${errorText}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`‚ùå Error: ${error.message}`, "error");
                }
            }

            async function checkJobStatus() {
                if (!currentJobId) {
                    showStatus(
                        "‚ö†Ô∏è No job ID available. Please start a job first.",
                        "warning"
                    );
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/job/${currentJobId}`,
                        {
                            headers: {
                                "X-API-Key": getApiKey(),
                            },
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        updateJobStatus(data);
                    } else {
                        showStatus(
                            `‚ùå Failed to get job status: ${response.status}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`‚ùå Error: ${error.message}`, "error");
                }
            }

            function updateJobStatus(data) {
                const {
                    jobId,
                    status,
                    totalStations,
                    processedStations,
                    failedStations,
                    images,
                } = data;

                // Update progress bar
                const progress =
                    totalStations > 0
                        ? ((processedStations / totalStations) * 100).toFixed(1)
                        : 0;
                const progressFill = document.getElementById("progressFill");
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${progress}% (${processedStations}/${totalStations})`;

                // Update status message
                let statusMessage = `
                <strong>üìä Job Status:</strong> ${status}<br>
                <strong>üéØ Progress:</strong> ${processedStations} / ${totalStations} stations<br>
                <strong>‚ùå Failed:</strong> ${failedStations || 0}
            `;

                if (status === "Completed") {
                    showStatus(
                        statusMessage +
                            "<br>‚úÖ <strong>Job Completed Successfully!</strong>",
                        "success"
                    );
                    stopStatusPolling();
                } else if (status === "Failed") {
                    showStatus(
                        statusMessage + "<br>‚ùå <strong>Job Failed!</strong>",
                        "error"
                    );
                    stopStatusPolling();
                } else {
                    showStatus(statusMessage, "info");
                }

                // Display images
                if (images && images.length > 0) {
                    displayImages(images);
                }
            }

            function displayImages(images) {
                const gallery = document.getElementById("imageGallery");
                gallery.innerHTML = "";

                images.forEach((img) => {
                    const card = document.createElement("div");
                    card.className = "image-card";
                    card.innerHTML = `
                    <img src="${img.imageUrl}" alt="${
                        img.stationName
                    }" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage Loading...%3C/text%3E%3C/svg%3E'">
                    <h3>${img.stationName}</h3>
                    <p>üå°Ô∏è Temperature: ${img.temperature || "N/A"}¬∞C</p>
                    <p>‚òÅÔ∏è Weather: ${img.weatherDescription || "N/A"}</p>
                `;
                    gallery.appendChild(card);
                });
            }

            function startStatusPolling() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }

                // Check immediately
                checkJobStatus();

                // Then check every 5 seconds
                statusCheckInterval = setInterval(() => {
                    checkJobStatus();
                }, 5000);
            }

            function stopStatusPolling() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            }

            // Initialize on page load
            window.addEventListener("load", () => {
                console.log("Azure Weather Image Generator loaded");
                console.log("API Base URL:", API_BASE_URL);
            });

            // Clean up on page unload
            window.addEventListener("beforeunload", () => {
                stopStatusPolling();
            });
        </script>
    </body>
</html>
