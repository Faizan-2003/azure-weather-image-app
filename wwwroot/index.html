<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Azure Weather Image Generator</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1200px;
                margin: 0 auto;
            }

            .header {
                text-align: center;
                color: white;
                margin-bottom: 30px;
            }

            .header h1 {
                font-size: 2.5em;
                margin-bottom: 10px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            }

            .header p {
                font-size: 1.2em;
                opacity: 0.9;
            }

            .card {
                background: white;
                border-radius: 15px;
                padding: 30px;
                margin-bottom: 20px;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            }

            .api-key-section {
                margin-bottom: 20px;
            }

            .api-key-section label {
                display: block;
                font-weight: bold;
                margin-bottom: 8px;
                color: #333;
            }

            .api-key-section input {
                width: 100%;
                padding: 12px;
                border: 2px solid #ddd;
                border-radius: 8px;
                font-size: 1em;
                transition: border-color 0.3s;
            }

            .api-key-section input:focus {
                outline: none;
                border-color: #667eea;
            }

            .api-key-section small {
                display: block;
                margin-top: 5px;
                color: #666;
            }

            .button-group {
                display: flex;
                gap: 15px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            button {
                flex: 1;
                min-width: 150px;
                padding: 15px 25px;
                font-size: 1.1em;
                font-weight: bold;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.3s;
                color: white;
            }

            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .btn-success {
                background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            }

            .btn-info {
                background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            .status-box {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                display: none;
            }

            .status-box.show {
                display: block;
            }

            .status-success {
                background: #d4edda;
                border: 1px solid #c3e6cb;
                color: #155724;
            }

            .status-error {
                background: #f8d7da;
                border: 1px solid #f5c6cb;
                color: #721c24;
            }

            .status-info {
                background: #d1ecf1;
                border: 1px solid #bee5eb;
                color: #0c5460;
            }

            .status-warning {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                color: #856404;
            }

            .job-status {
                margin-top: 20px;
            }

            .progress-bar {
                width: 100%;
                height: 30px;
                background: #f0f0f0;
                border-radius: 15px;
                overflow: hidden;
                margin: 15px 0;
                display: none;
            }

            .progress-bar.show {
                display: block;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
                transition: width 0.5s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            }

            .image-gallery {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .image-card {
                background: #f9f9f9;
                border-radius: 10px;
                padding: 15px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s;
            }

            .image-card:hover {
                transform: translateY(-5px);
            }

            .image-card img {
                width: 100%;
                border-radius: 8px;
                margin-bottom: 10px;
                background: #ddd;
                min-height: 200px;
                object-fit: cover;
            }

            .image-card h3 {
                color: #333;
                margin-bottom: 5px;
                font-size: 1.1em;
            }

            .image-card p {
                color: #666;
                font-size: 0.9em;
            }

            .spinner {
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top-color: white;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .endpoint-info {
                background: #f8f9fa;
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                font-family: "Courier New", monospace;
            }

            .endpoint-info h3 {
                margin-bottom: 10px;
                color: #333;
            }

            .endpoint-info code {
                background: #e9ecef;
                padding: 2px 6px;
                border-radius: 4px;
                color: #d63384;
            }

            .loading {
                text-align: center;
                padding: 20px;
            }

            /* Tabs */
            .tabs {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                border-bottom: 2px solid #e0e0e0;
            }

            .tab {
                padding: 12px 24px;
                cursor: pointer;
                background: transparent;
                border: none;
                border-bottom: 3px solid transparent;
                font-size: 1em;
                font-weight: 600;
                color: #666;
                transition: all 0.3s;
            }

            .tab:hover {
                color: #667eea;
                transform: none;
                box-shadow: none;
            }

            .tab.active {
                color: #667eea;
                border-bottom-color: #667eea;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }

            .history-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 15px;
            }

            .history-table th,
            .history-table td {
                padding: 12px;
                text-align: left;
                border-bottom: 1px solid #e0e0e0;
            }

            .history-table th {
                background: #f8f9fa;
                font-weight: 600;
                color: #333;
            }

            .history-table tr:hover {
                background: #f8f9fa;
            }

            .status-badge {
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 600;
            }

            .status-completed {
                background: #d4edda;
                color: #155724;
            }

            .status-inprogress {
                background: #fff3cd;
                color: #856404;
            }

            .status-failed {
                background: #f8d7da;
                color: #721c24;
            }

            .view-job-btn {
                padding: 6px 12px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
            }

            .view-job-btn:hover {
                background: #5568d3;
                transform: none;
                box-shadow: none;
            }

            @media (max-width: 768px) {
                .button-group {
                    flex-direction: column;
                }

                .header h1 {
                    font-size: 1.8em;
                }

                .image-gallery {
                    grid-template-columns: 1fr;
                }

                .tabs {
                    overflow-x: auto;
                }

                .history-table {
                    font-size: 0.85em;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Azure Weather Image Generator</h1>
                <p>Generate weather images for Dutch weather stations</p>
            </div>

            <div class="card">
                <!-- Tabs Navigation -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('current')"> Current Job</button>
                    <button class="tab" onclick="switchTab('history')"> Job History</button>
                    <button class="tab" onclick="switchTab('endpoints')"> API Endpoints</button>
                </div>

                <!-- Current Job Tab -->
                <div id="currentTab" class="tab-content active">
                <div class="api-key-section">
                    <label for="apiKey">API Key:</label>
                    <input
                        type="text"
                        id="apiKey"
                        placeholder="Enter your API key"
                        value="test-api-key-12345"
                    />
                    <small>Default: test-api-key-12345</small>
                </div>

                <div class="button-group">
                    <button class="btn-success" onclick="testHealth()">
                        Test Health
                    </button>
                    <button class="btn-primary" onclick="startJob()">
                        Start Weather Job
                    </button>
                    <button
                        class="btn-info"
                        onclick="checkJobStatus()"
                        id="checkStatusBtn"
                        disabled
                    >
                        Check Job Status
                    </button>
                </div>

                <div id="statusBox" class="status-box"></div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div class="job-status" id="jobStatus"></div>
                
                <div id="statusEndpointLink" style="margin: 15px 0; color: #999; font-style: italic;">
                    Start a job first to get the Job ID
                </div>

                <div class="image-gallery" id="imageGallery"></div>

                </div>
                <!-- End Current Job Tab -->

                <!-- History Tab -->
                <div id="historyTab" class="tab-content">
                    <h2 style="margin-bottom: 15px;"> Job History</h2>
                    <button class="btn-info" onclick="loadJobHistory()" style="margin-bottom: 15px;">
                        Refresh History
                    </button>
                    <div id="historyLoading" class="loading" style="display: none;">
                        Loading job history...
                    </div>
                    <div id="historyContainer"></div>
                </div>

                <!-- Endpoints Tab -->
                <div id="endpointsTab" class="tab-content">
                <div class="endpoint-info">
                    <h3>üîå API Endpoints Documentation</h3>
                    
                    <!-- Authentication Info -->
                    <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                        <h4 style="margin-top: 0; color: #856404;">üîë Authentication</h4>
                        <p style="margin: 5px 0;"><strong>Method 1 - Header (Recommended):</strong></p>
                        <code style="background: white; padding: 8px; display: block; margin: 5px 0; border-radius: 4px;">X-API-Key: test-api-key-12345</code>
                        
                        <p style="margin: 10px 0 5px 0;"><strong>Method 2 - Query Parameter (Browser-friendly):</strong></p>
                        <code style="background: white; padding: 8px; display: block; margin: 5px 0; border-radius: 4px;">?apiKey=test-api-key-12345</code>
                    </div>

                    <!-- Public Endpoints -->
                    <div style="margin: 20px 0; padding: 15px; background: #d4edda; border-radius: 8px; border-left: 4px solid #28a745;">
                        <h4 style="margin-top: 0; color: #155724;">‚úÖ Public Endpoints (No Auth Required)</h4>
                        
                        <p style="margin-bottom: 15px">
                            <strong>1. Health Check</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">GET /api/health</code><br />
                            <a href="https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/health" target="_blank" 
                               style="color: #28a745; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 5px;">
                                üîó Test in Browser
                            </a>
                            <span style="color: #666; margin-left: 10px; font-size: 0.9em;">Returns: Server status</span>
                        </p>

                        <p style="margin-bottom: 15px">
                            <strong>2. Web Interface (This Page)</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">GET /api/ServeWebsite</code><br />
                            <a href="https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/ServeWebsite" target="_blank"
                               style="color: #28a745; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 5px;">
                                üîó Open Web UI
                            </a>
                            <span style="color: #666; margin-left: 10px; font-size: 0.9em;">Returns: Interactive UI</span>
                        </p>
                    </div>

                    <!-- Protected Endpoints -->
                    <div style="margin: 20px 0; padding: 15px; background: #d1ecf1; border-radius: 8px; border-left: 4px solid #0c5460;">
                        <h4 style="margin-top: 0; color: #0c5460;">üîí Protected Endpoints (Auth Required)</h4>
                        
                        <p style="margin-bottom: 15px">
                            <strong>3. Start Weather Job</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">POST /api/StartJob</code><br />
                            <button onclick="startJob()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px;">
                                ‚ñ∂Ô∏è Start New Job
                            </button>
                            <span style="color: #666; margin-left: 10px; font-size: 0.9em;">Returns: Job ID and status</span><br />
                            <small style="color: #666; display: block; margin-top: 5px;">‚ö†Ô∏è Requires POST request (use button or API client)</small>
                        </p>

                        <p style="margin-bottom: 15px">
                            <strong>4. Get Job Status</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">GET /api/job/{jobId}</code><br />
                            <span id="statusEndpointLink2" style="color: #999; font-style: italic;">Start a job first to get the Job ID</span><br />
                            <small style="color: #666; display: block; margin-top: 5px;">Returns: Job progress, status, and image URLs with SAS tokens</small>
                        </p>

                        <p style="margin-bottom: 15px">
                            <strong>5. Get Job History</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">GET /api/jobs/history</code><br />
                            <a href="https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/jobs/history?apiKey=test-api-key-12345" target="_blank"
                               style="color: #17a2b8; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 5px;">
                                üîó View in Browser (with API key)
                            </a>
                            <span style="color: #666; margin-left: 10px; font-size: 0.9em;">Returns: All jobs history</span>
                        </p>

                        <p style="margin-bottom: 15px">
                            <strong>6. Test Image Generation</strong><br />
                            <code style="background: white; padding: 8px; display: inline-block; margin: 5px 0; border-radius: 4px;">GET /api/test/image</code><br />
                            <a href="https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/test/image?apiKey=test-api-key-12345" target="_blank"
                               style="color: #17a2b8; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 5px;">
                                üîó Generate Test Image
                            </a>
                            <span style="color: #666; margin-left: 10px; font-size: 0.9em;">Returns: Weather image (PNG)</span>
                        </p>
                    </div>

                    <!-- Usage Examples -->
                    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                        <h4 style="margin-top: 0; color: #667eea;">üí° Usage Examples</h4>
                        
                        <p><strong>cURL (Header-based):</strong></p>
                        <pre style="background: white; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">curl -X POST -H "X-API-Key: test-api-key-12345" \
  https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/StartJob</pre>

                        <p style="margin-top: 15px;"><strong>PowerShell (Query parameter):</strong></p>
                        <pre style="background: white; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">Invoke-RestMethod -Uri "https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/StartJob?apiKey=test-api-key-12345" -Method POST</pre>

                        <p style="margin-top: 15px;"><strong>Browser (GET endpoints only):</strong></p>
                        <pre style="background: white; padding: 12px; border-radius: 4px; overflow-x: auto; font-size: 0.85em;">https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net/api/jobs/history?apiKey=test-api-key-12345</pre>
                    </div>

                    <!-- Architecture Info -->
                    <div style="margin: 20px 0; padding: 15px; background: #e7e7e7; border-radius: 8px; border-left: 4px solid #6c757d;">
                        <h4 style="margin-top: 0; color: #495057;">üèóÔ∏è Processing Flow</h4>
                        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.8;">
                            <li><strong>POST /api/StartJob</strong> ‚Üí Creates job in Table Storage</li>
                            <li>Sends message to <code>job-start-queue</code></li>
                            <li><strong>JobInitiator</strong> (Queue Trigger) ‚Üí Fetches 50 weather stations</li>
                            <li>Sends 50 messages to <code>image-processing-queue</code></li>
                            <li><strong>ProcessImage</strong> (Queue Trigger √ó 50) ‚Üí Generates images in parallel</li>
                            <li>Each image uploaded to <strong>Blob Storage</strong> with SAS token</li>
                            <li>Progress tracked in <strong>Table Storage</strong></li>
                            <li><strong>GET /api/job/{id}</strong> ‚Üí Returns status and image URLs</li>
                        </ol>
                    </div>
            </div>
        </div>

        <script>
            const API_BASE_URL =
                "https://weather-image-func-eg2kg4p2kzwtc.azurewebsites.net";
            let currentJobId = null;
            let statusCheckInterval = null;

            function getApiKey() {
                return (
                    document.getElementById("apiKey").value ||
                    "test-api-key-12345"
                );
            }

            function showStatus(message, type = "info") {
                const statusBox = document.getElementById("statusBox");
                statusBox.className = `status-box show status-${type}`;
                statusBox.innerHTML = message;
            }

            function hideStatus() {
                const statusBox = document.getElementById("statusBox");
                statusBox.className = "status-box";
            }

            function testEndpoint(event, path, method) {
                // For GET requests, let the browser handle it normally
                if (method === "GET") {
                    return true; // Allow default link behavior
                }
                // For POST, prevent default and use our function
                event.preventDefault();
                if (path.includes("/job/start")) {
                    startJob();
                }
                return false;
            }

            async function testHealth() {
                showStatus("Testing health endpoint...", "info");

                try {
                    const response = await fetch(`${API_BASE_URL}/api/health`, {
                        headers: {
                            "X-API-Key": getApiKey(),
                        },
                    });

                    if (response.ok) {
                        const text = await response.text();
                        showStatus(
                            `Health Check Passed!<br><strong>${text}</strong>`,
                            "success"
                        );
                    } else {
                        showStatus(
                            `Health check failed: ${response.status} ${response.statusText}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`Error: ${error.message}`, "error");
                }
            }

            async function startJob() {
                showStatus("Starting weather image generation job...", "info");
                document.getElementById("imageGallery").innerHTML = "";

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/job/start`,
                        {
                            method: "POST",
                            headers: {
                                "X-API-Key": getApiKey(),
                                "Content-Type": "application/json",
                            },
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();

                        // Handle both camelCase and PascalCase from API
                        const jobId = data.jobId || data.JobId;
                        const status = data.status || data.Status;
                        const message = data.message || data.Message;

                        currentJobId = jobId;

                        console.log("Job started:", {
                            jobId,
                            status,
                            message,
                            rawData: data,
                        });

                        showStatus(
                            `Job Started Successfully!<br><strong>Job ID:</strong> ${jobId}<br><strong>Status:</strong> ${status}<br><strong>Message:</strong> ${message}`,
                            "success"
                        );

                        // Update the status endpoint link with the actual job ID
                        const statusUrl = `${API_BASE_URL}/api/job/${jobId}`;
                        const statusLink = document.getElementById("statusEndpointLink");
                        if (statusLink) {
                            statusLink.innerHTML = `
                                <a href="${statusUrl}" 
                                   target="_blank" 
                                   onclick="checkJobStatus(); return false;"
                                   style="color: #667eea; text-decoration: none; font-weight: bold;">
                                     ${statusUrl}
                                </a>
                                <span style="color: #28a745; margin-left: 10px;">Click to check status</span>
                            `;
                        }
                        
                        // Also update in endpoints tab if it exists
                        const statusLink2 = document.getElementById("statusEndpointLink2");
                        if (statusLink2) {
                            statusLink2.innerHTML = `
                                <a href="${statusUrl}" 
                                   target="_blank" 
                                   onclick="checkJobStatus(); return false;"
                                   style="color: #667eea; text-decoration: none; font-weight: bold;">
                                     ${statusUrl}
                                </a>
                            `;
                        }

                        document.getElementById(
                            "checkStatusBtn"
                        ).disabled = false;
                        document
                            .getElementById("progressBar")
                            .classList.add("show");

                        // Auto-start checking status
                        startStatusPolling();
                    } else {
                        const errorText = await response.text();
                        showStatus(
                            `Failed to start job: ${response.status}<br>${errorText}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`Error: ${error.message}`, "error");
                }
            }

            async function checkJobStatus() {
                if (!currentJobId) {
                    showStatus(
                        "No job ID available. Please start a job first.",
                        "warning"
                    );
                    return;
                }

                try {
                    const response = await fetch(
                        `${API_BASE_URL}/api/job/${currentJobId}`,
                        {
                            headers: {
                                "X-API-Key": getApiKey(),
                            },
                        }
                    );

                    if (response.ok) {
                        const data = await response.json();
                        updateJobStatus(data);
                    } else {
                        showStatus(
                            `Failed to get job status: ${response.status}`,
                            "error"
                        );
                    }
                } catch (error) {
                    showStatus(`Error: ${error.message}`, "error");
                }
            }

            function updateJobStatus(data) {
                // Handle both camelCase and PascalCase from API
                const jobId = data.jobId || data.JobId;
                const status = data.status || data.Status;
                const totalStations =
                    data.totalStations || data.TotalStations || 0;
                const processedStations =
                    data.processedStations || data.ProcessedStations || 0;
                const failedStations =
                    data.failedStations || data.FailedStations || 0;
                const images = data.images || data.Images || [];

                console.log("Job status update:", {
                    jobId,
                    status,
                    totalStations,
                    processedStations,
                    failedStations,
                    images,
                    rawData: data,
                });

                // Update progress bar
                const progress =
                    totalStations > 0
                        ? ((processedStations / totalStations) * 100).toFixed(1)
                        : 0;
                const progressFill = document.getElementById("progressFill");
                const progressBar = document.getElementById("progressBar");
                
                progressFill.style.width = `${progress}%`;
                progressFill.textContent = `${progress}% (${processedStations}/${totalStations})`;
                progressBar.classList.add("show"); // Always show progress bar when viewing job status

                // Update status message
                let statusMessage = `
                <strong> Job ID:</strong> ${jobId}<br>
                <strong> Job Status:</strong> ${status}<br>
                <strong> Progress:</strong> ${processedStations} / ${totalStations} stations<br>
                <strong> Failed:</strong> ${failedStations || 0}
            `;

                if (status === "Completed") {
                    showStatus(
                        statusMessage +
                            "<br> <strong>Job Completed Successfully!</strong>",
                        "success"
                    );
                    stopStatusPolling();
                } else if (status === "Failed") {
                    showStatus(
                        statusMessage + "<br> <strong>Job Failed!</strong>",
                        "error"
                    );
                    stopStatusPolling();
                } else {
                    showStatus(statusMessage, "info");
                }

                // Display images
                if (images && images.length > 0) {
                    displayImages(images);
                }
            }

            function displayImages(images) {
                const gallery = document.getElementById("imageGallery");
                gallery.innerHTML = "";

                images.forEach((img) => {
                    // Handle both camelCase and PascalCase
                    const imageUrl = img.imageUrl || img.ImageUrl;
                    const stationName = img.stationName || img.StationName;
                    const card = document.createElement("div");
                    card.className = "image-card";
                    card.innerHTML = `
                    <img src="${imageUrl}" alt="${stationName}" loading="lazy" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 fill=%22%23999%22 text-anchor=%22middle%22 dy=%22.3em%22%3EImage Loading...%3C/text%3E%3C/svg%3E'">
                    <h3>${stationName}</h3>
         
                `;
                    gallery.appendChild(card);
                });
            }

            function startStatusPolling() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }

                // Check immediately
                checkJobStatus();

                // Then check every 5 seconds
                statusCheckInterval = setInterval(() => {
                    checkJobStatus();
                }, 5000);
            }

            function stopStatusPolling() {
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
            }

            // Initialize on page load
            window.addEventListener("load", () => {
                console.log("Azure Weather Image Generator loaded");
                console.log("API Base URL:", API_BASE_URL);
            });

            // Clean up on page unload
            window.addEventListener("beforeunload", () => {
                stopStatusPolling();
            });

            // Tab switching function
            function switchTab(tabName) {
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active class from all tab buttons
                document.querySelectorAll('.tab').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Show selected tab
                if (tabName === 'current') {
                    document.getElementById('currentTab').classList.add('active');
                    document.querySelector('.tab:nth-child(1)').classList.add('active');
                } else if (tabName === 'history') {
                    document.getElementById('historyTab').classList.add('active');
                    document.querySelector('.tab:nth-child(2)').classList.add('active');
                    loadJobHistory(); // Auto-load history when tab is opened
                } else if (tabName === 'endpoints') {
                    document.getElementById('endpointsTab').classList.add('active');
                    document.querySelector('.tab:nth-child(3)').classList.add('active');
                }
            }

            // Load job history
            async function loadJobHistory() {
                const loadingDiv = document.getElementById('historyLoading');
                const containerDiv = document.getElementById('historyContainer');
                
                loadingDiv.style.display = 'block';
                containerDiv.innerHTML = '';
                
                try {
                    const response = await fetch(`${API_BASE_URL}/api/jobs/history`, {
                        headers: {
                            'X-API-Key': getApiKey()
                        }
                    });
                    
                    if (response.ok) {
                        const jobs = await response.json();
                        displayJobHistory(jobs);
                    } else {
                        containerDiv.innerHTML = `<p style="color: #721c24;">Failed to load job history: ${response.status}</p>`;
                    }
                } catch (error) {
                    containerDiv.innerHTML = `<p style="color: #721c24;">Error loading history: ${error.message}</p>`;
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            // Display job history in a table
            function displayJobHistory(jobs) {
                const container = document.getElementById('historyContainer');
                
                if (!jobs || jobs.length === 0) {
                    container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No job history found. Start a job to see it here!</p>';
                    return;
                }
                
                let tableHTML = `
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Created</th>
                                <th>Status</th>
                                <th>Progress</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                jobs.forEach(job => {
                    const createdDate = new Date(job.createdAt || job.CreatedAt).toLocaleString();
                    const status = job.status || job.Status || 'Unknown';
                    const total = job.totalStations || job.TotalStations || 0;
                    const processed = job.processedStations || job.ProcessedStations || 0;
                    const jobId = job.partitionKey || job.PartitionKey;
                    
                    const statusClass = status.toLowerCase() === 'completed' ? 'status-completed' : 
                                       status.toLowerCase() === 'inprogress' ? 'status-inprogress' : 
                                       'status-failed';
                    
                    tableHTML += `
                        <tr>
                            <td><code>${jobId}</code></td>
                            <td>${createdDate}</td>
                            <td><span class="status-badge ${statusClass}">${status}</span></td>
                            <td>${processed} / ${total}</td>
                            <td><button class="view-job-btn" onclick="viewJobFromHistory('${jobId}')">View</button></td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = tableHTML;
            }

            // View a job from history
            function viewJobFromHistory(jobId) {
                currentJobId = jobId;
                
                // Update the status endpoint link
                const statusUrl = `${API_BASE_URL}/api/job/${jobId}`;
                const statusLink = document.getElementById("statusEndpointLink");
                if (statusLink) {
                    statusLink.innerHTML = `
                        <a href="${statusUrl}" 
                           target="_blank" 
                           onclick="checkJobStatus(); return false;"
                           style="color: #667eea; text-decoration: none; font-weight: bold;">
                             ${statusUrl}
                        </a>
                        <span style="color: #28a745; margin-left: 10px;">Click to check status</span>
                    `;
                }
                
                // Switch to current tab and load the job
                switchTab('current');
                document.getElementById('checkStatusBtn').disabled = false;
                checkJobStatus();
            }
        </script>
    </body>
</html>
