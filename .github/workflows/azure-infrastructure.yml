name: Deploy Azure Infrastructure

on:
    workflow_dispatch:
        inputs:
            resourceGroupName:
                description: "Resource Group Name"
                required: true
                default: "rg-weather-image-app"
            location:
                description: "Azure Region"
                required: true
                default: "westeurope"
            apiKey:
                description: "API Key for authentication"
                required: true
            unsplashAccessKey:
                description: "Unsplash API Key (optional)"
                required: false

jobs:
    deploy-infrastructure:
        runs-on: ubuntu-latest

        steps:
            - name: "Checkout GitHub Action"
              uses: actions/checkout@v4

            - name: "Login to Azure"
              uses: azure/login@v1
              with:
                  creds: ${{ secrets.AZURE_CREDENTIALS }}

            - name: "Create Resource Group"
              uses: azure/CLI@v1
              with:
                  inlineScript: |
                      az group create \
                        --name ${{ github.event.inputs.resourceGroupName }} \
                        --location ${{ github.event.inputs.location }}

            - name: "Deploy Bicep Template"
              uses: azure/arm-deploy@v1
              id: deploy
              with:
                  subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
                  resourceGroupName: ${{ github.event.inputs.resourceGroupName }}
                  template: ./deploy/main.bicep
                  parameters: >
                      apiKey=${{ github.event.inputs.apiKey }}
                      unsplashAccessKey=${{ github.event.inputs.unsplashAccessKey }}
                  failOnStdErr: false

            - name: "Display Deployment Outputs"
              run: |
                  echo "Function App Name: ${{ steps.deploy.outputs.functionAppName }}"
                  echo "Function App URL: ${{ steps.deploy.outputs.functionAppUrl }}"
                  echo "Storage Account: ${{ steps.deploy.outputs.storageAccountName }}"
